<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ruleta Din√°mica</title>
  <link rel="stylesheet" href="style.css" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
</head>
<body>
  <div class="ruleta-container">
    <div class="flecha"></div>
    <canvas id="ruleta"></canvas>
    <button id="boton-girar">Girar</button>
    <div id="resultado"></div>
  </div>

  <script src="script.js"></script>
<script type="module">
  // === Importar Firebase (v12.4.0) ===
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
  import { getFirestore, doc, getDoc, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-analytics.js";

  // === Configuraci√≥n del proyecto ===
  const firebaseConfig = {
    apiKey: "AIzaSyA3otUc6hkrH3VLRuZNuHGpwkTR7XIN0SI",
    authDomain: "ruletaweb-ee9eb.firebaseapp.com",
    projectId: "ruletaweb-ee9eb",
    storageBucket: "ruletaweb-ee9eb.firebasestorage.app",
    messagingSenderId: "432493115869",
    appId: "1:432493115869:web:bd86586fe89e5790779e34",
    measurementId: "G-8W7HEP3JZW"
  };

  // === Inicializar Firebase ===
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const analytics = getAnalytics(app);

  // === Pedir o recuperar nombre del usuario ===
  let nombre = localStorage.getItem("nombreUsuario");
  if (!nombre) {
    nombre = prompt("Por favor, ingresa tu nombre:");
    if (!nombre) nombre = "Invitado";
    localStorage.setItem("nombreUsuario", nombre);
  }

  const userRef = doc(db, "usuarios", nombre);
  const botonGirar = document.getElementById("boton-girar");
  let girosRestantes = 0;

  // === Verificar si existe el usuario o crearlo ===
  async function verificarUsuario() {
    try {
      const userSnap = await getDoc(userRef);

      if (!userSnap.exists()) {
        await setDoc(userRef, { nombre, giros_restantes: 3 });
        console.log("‚úÖ Usuario nuevo guardado:", nombre);
        alert(`¬°Bienvenido, ${nombre}! Tienes 3 giros disponibles üéâ`);
        girosRestantes = 3;
      } else {
        const data = userSnap.data();
        console.log("üë§ Usuario encontrado:", data);
        girosRestantes = data.giros_restantes;
        if (girosRestantes > 0) {
          alert(`Hola de nuevo, ${nombre}. Te quedan ${girosRestantes} giros.`);
        } else {
          alert(`Hola de nuevo, ${nombre}. Ya no tienes giros disponibles üò¢`);
          bloquearBoton();
        }
      }
    } catch (error) {
      console.error("‚ùå Error al acceder a Firestore:", error);
    }
  }

  // === Funci√≥n para bloquear el bot√≥n ===
  function bloquearBoton() {
    botonGirar.disabled = true;
    botonGirar.style.opacity = "0.5";
    botonGirar.style.cursor = "not-allowed";
    botonGirar.textContent = "Sin giros disponibles";
  }

  // === Funci√≥n para restar giros ===
  async function usarGiro() {
    if (girosRestantes <= 0) {
      alert("Ya no tienes giros disponibles üò¢");
      bloquearBoton();
      return;
    }

    // Ejecuta tu funci√≥n original si existe
    if (typeof girarRuleta === "function") {
      girarRuleta();
    } else {
      console.warn("‚ö†Ô∏è No se encontr√≥ la funci√≥n girarRuleta().");
    }

    girosRestantes--;

    try {
      await updateDoc(userRef, { giros_restantes: girosRestantes });
      console.log(`üî• Giros restantes actualizados: ${girosRestantes}`);
    } catch (error) {
      console.error("‚ùå Error al actualizar giros:", error);
    }

    if (girosRestantes === 0) {
      alert("¬°Has usado todos tus giros!");
      bloquearBoton();
    } else {
      alert(`Te quedan ${girosRestantes} giros.`);
    }
  }

  // === Evento del bot√≥n ===
  botonGirar.addEventListener("click", usarGiro);

  // === Ejecutar la verificaci√≥n al cargar ===
  await verificarUsuario();
</script>

</body>
</html>

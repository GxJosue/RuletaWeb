<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ruleta Premios</title>
  <link rel="stylesheet" href="style.css" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <link rel="icon" href="img/favicon.jpg" type="image/x-icon">
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
</head>
<body>
  <div class="ruleta-container">
    <div class="flecha"></div>
    <canvas id="ruleta"></canvas>
    <button id="boton-girar">Girar</button>
    <div id="resultado" class="resultado-premio"></div>
    <div id="giros-restantes" class="giros-info"></div>
    <button id="cambiar-usuario">Ingresar usuario</button>
  </div>

  <script src="script.js"></script>
<script type="module">
  const girosInfo = document.getElementById("giros-restantes");
  const botonGirar = document.getElementById("boton-girar");
  document.getElementById("cambiar-usuario").addEventListener("click", () => {
  localStorage.removeItem("nombreUsuario");
  location.reload();
});
  

  // === Importar Firebase (v12.4.0) ===
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
  import { getFirestore, doc, getDoc, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-analytics.js";

  // === Configuraci√≥n del proyecto ===
  const firebaseConfig = {
    apiKey: "AIzaSyA3otUc6hkrH3VLRuZNuHGpwkTR7XIN0SI",
    authDomain: "ruletaweb-ee9eb.firebaseapp.com",
    projectId: "ruletaweb-ee9eb",
    storageBucket: "ruletaweb-ee9eb.firebasestorage.app",
    messagingSenderId: "432493115869",
    appId: "1:432493115869:web:bd86586fe89e5790779e34",
    measurementId: "G-8W7HEP3JZW"
  };

  // === Inicializar Firebase ===
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const analytics = getAnalytics(app);

  // === Pedir o recuperar nombre del usuario ===
let nombre = localStorage.getItem("nombreUsuario");

async function solicitarNombre() {
  return new Promise((resolve) => {
    const modal = document.getElementById("modal");
    const modalText = document.getElementById("modal-text");
    const modalInput = document.getElementById("modal-input");
    const modalConfirm = document.getElementById("modal-confirm");
    const closeButton = document.querySelector(".close-button");

    modalText.textContent = "Por favor, ingresa tu usuario asignado:";
    modal.style.display = "flex";
    modalInput.value = "";

    function cerrarModal() {
      modal.style.display = "none";
    }

    closeButton.onclick = cerrarModal;

    modalConfirm.onclick = () => {
      const valor = modalInput.value.trim();
      if (valor.length < 2) {
        modalText.textContent = "Debes ingresar un nombre v√°lido.";
        return;
      }
      localStorage.setItem("nombreUsuario", valor);
      cerrarModal();
      resolve(valor);
    };
  });
}

if (!nombre) {
  nombre = await solicitarNombre();
}

  const userRef = doc(db, "usuarios", nombre);
  let girosRestantes = 0;

  // === Verificar si existe el usuario o crearlo ===
  async function verificarUsuario() {
    try {
      const userSnap = await getDoc(userRef);

      if (!userSnap.exists()) {
        girosInfo.textContent = `Hola, ${nombre}. No est√°s registrado.`;
        bloquearBoton();
        return;
        }
       else {
        const data = userSnap.data();
        girosRestantes = data.giros_restantes;
        if (girosRestantes > 0) {
          girosInfo.textContent = `Hola, ${nombre}. Te quedan ${girosRestantes} giros.`;
        } else {
          girosInfo.textContent = `Ya no tienes giros disponibles üò¢`;
          bloquearBoton();
        }
      }
    } catch (error) {
      console.error("‚ùå Error al acceder a Firestore:", error);
      girosInfo.textContent = "Error al cargar tus datos. Intenta m√°s tarde.";
    }
  }

  // === Funci√≥n para bloquear el bot√≥n ===
  function bloquearBoton() {
    botonGirar.disabled = true;
    botonGirar.style.opacity = "0.5";
    botonGirar.style.cursor = "not-allowed";
    botonGirar.textContent = "Sin giros disponibles";
  }

  // === Funci√≥n para restar giros ===
  async function usarGiro() {
    if (girosRestantes <= 0) {
      girosInfo.textContent = "Ya no tienes giros disponibles üò¢";
      bloquearBoton();
      return;
    }

    // Ejecuta tu funci√≥n original si existe
    if (typeof girarRuleta === "function") {
      girarRuleta();
    } else {
      console.warn("‚ö†Ô∏è No se encontr√≥ la funci√≥n girarRuleta().");
    }

    girosRestantes--;

    try {
      await updateDoc(userRef, { giros_restantes: girosRestantes });
      console.log(`üî• Giros restantes actualizados: ${girosRestantes}`);
    } catch (error) {
      console.error("‚ùå Error al actualizar giros:", error);
    }

    if (girosRestantes === 0) {
      girosInfo.textContent = "¬°Has usado todos tus giros!";
      bloquearBoton();
    } else {
      girosInfo.textContent = `Te quedan ${girosRestantes} giros.`;
    }
  }

  // === Evento del bot√≥n ===
  botonGirar.addEventListener("click", usarGiro);

  // === Ejecutar la verificaci√≥n al cargar ===
  await verificarUsuario();
</script>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
<!-- Modal personalizado -->
<div id="modal" class="modal">
  <div class="modal-content">
    <span class="close-button">&times;</span>
    <p id="modal-text"></p>
    <input type="text" id="modal-input" placeholder="Ingresa tu usuario" />
    <button id="modal-confirm">Confirmar</button>
  </div>
</div>
</body>
</html>
